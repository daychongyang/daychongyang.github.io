<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise | DayDayUp</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="

一个具拥有 then 方法且其行为符合 Promise/A+ 规范的对象或方法.
一个异步操作的最终结果.

Promise 语法

new Promise(function(resolve, reject) {} /* exxcutor /);

executor 是一个带有 resolve 和 reject 两个函数作为参数的函数. ...">
    <link rel="preload" href="/assets/css/0.styles.a353c32a.css" as="style"><link rel="preload" href="/assets/js/app.2147977e.js" as="script"><link rel="preload" href="/assets/js/6.db028c5e.js" as="script"><link rel="preload" href="/assets/js/3.245a09f5.js" as="script"><link rel="preload" href="/assets/js/30.e37f3831.js" as="script"><link rel="prefetch" href="/assets/js/10.ecdeefe8.js"><link rel="prefetch" href="/assets/js/11.1559831c.js"><link rel="prefetch" href="/assets/js/12.9a72e3fe.js"><link rel="prefetch" href="/assets/js/13.f1a42d40.js"><link rel="prefetch" href="/assets/js/14.96ba2aa6.js"><link rel="prefetch" href="/assets/js/15.b705d14e.js"><link rel="prefetch" href="/assets/js/16.c0e839f0.js"><link rel="prefetch" href="/assets/js/17.4ee6ba9c.js"><link rel="prefetch" href="/assets/js/18.0bb30add.js"><link rel="prefetch" href="/assets/js/19.0fc706f9.js"><link rel="prefetch" href="/assets/js/20.28b36291.js"><link rel="prefetch" href="/assets/js/21.3946c588.js"><link rel="prefetch" href="/assets/js/22.9c98acf1.js"><link rel="prefetch" href="/assets/js/23.a5010020.js"><link rel="prefetch" href="/assets/js/24.e3db5ee3.js"><link rel="prefetch" href="/assets/js/25.395efada.js"><link rel="prefetch" href="/assets/js/26.0ad8a102.js"><link rel="prefetch" href="/assets/js/27.6f79b6f1.js"><link rel="prefetch" href="/assets/js/28.d56264e2.js"><link rel="prefetch" href="/assets/js/29.570d050d.js"><link rel="prefetch" href="/assets/js/31.0cbff5a4.js"><link rel="prefetch" href="/assets/js/32.d58ae1c2.js"><link rel="prefetch" href="/assets/js/33.ae1788cd.js"><link rel="prefetch" href="/assets/js/34.dd5ab556.js"><link rel="prefetch" href="/assets/js/35.ece5cfc5.js"><link rel="prefetch" href="/assets/js/36.8309bbb9.js"><link rel="prefetch" href="/assets/js/37.e8a041da.js"><link rel="prefetch" href="/assets/js/38.38fac1fa.js"><link rel="prefetch" href="/assets/js/39.69eaa1e9.js"><link rel="prefetch" href="/assets/js/4.ce77a12f.js"><link rel="prefetch" href="/assets/js/40.b576ec5f.js"><link rel="prefetch" href="/assets/js/41.9958d5ef.js"><link rel="prefetch" href="/assets/js/42.9ab554fb.js"><link rel="prefetch" href="/assets/js/43.98f0534b.js"><link rel="prefetch" href="/assets/js/44.9904eef6.js"><link rel="prefetch" href="/assets/js/45.ca4e4e77.js"><link rel="prefetch" href="/assets/js/46.1cf33e23.js"><link rel="prefetch" href="/assets/js/47.7c1c7091.js"><link rel="prefetch" href="/assets/js/48.794e9480.js"><link rel="prefetch" href="/assets/js/49.c0a20b6c.js"><link rel="prefetch" href="/assets/js/5.e388c62c.js"><link rel="prefetch" href="/assets/js/50.be34807f.js"><link rel="prefetch" href="/assets/js/51.23ded8b4.js"><link rel="prefetch" href="/assets/js/52.55a9b025.js"><link rel="prefetch" href="/assets/js/53.8469c5ae.js"><link rel="prefetch" href="/assets/js/54.9ac540ca.js"><link rel="prefetch" href="/assets/js/55.afe885b1.js"><link rel="prefetch" href="/assets/js/56.92b0cf61.js"><link rel="prefetch" href="/assets/js/57.a0f30371.js"><link rel="prefetch" href="/assets/js/7.8a507f46.js"><link rel="prefetch" href="/assets/js/8.9c6f3d77.js"><link rel="prefetch" href="/assets/js/9.136aab48.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.21336384.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a353c32a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">DayDayUp </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Daily</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="https://github.com/daychongyang/daychongyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">DayDayUp </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Daily</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="https://github.com/daychongyang/daychongyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Promise
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Day</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-03-24T00:00:00.000Z">
      2020-03-24
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/JavaScript" data-v-d832e844> JavaScript </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Promise" data-v-d832e844> Promise </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="promise-是什么"><a href="#promise-是什么" class="header-anchor">#</a> Promise 是什么?</h2> <ul><li>一个具拥有 <code>then</code> 方法且其行为符合 <code>Promise/A+</code> 规范的对象或方法.</li> <li>一个异步操作的最终结果.</li></ul> <h2 id="promise-语法"><a href="#promise-语法" class="header-anchor">#</a> Promise 语法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">/** exxcutor */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>executor</code> 是一个带有 <code>resolve</code> 和 <code>reject</code> 两个函数作为参数的函数.</p> <p><code>Promise</code> 构造函数执行时, 立即调用 <code>executor</code> 函数, <code>resolve</code> 和 <code>reject</code> 两个函数作为参数传递给 <code>executor</code>. <code>executor</code>函数内部可执行一些异步操作, 待异步操作执行完成(成功/失败),<code>resolve</code> 和 <code>reject</code> 函数被调用时, 分别将 <code>Promise</code> 状态 改为 <code>fulfilled</code> (完成) 或 <code>rejected</code>(失败). 且 <code>executor</code> 函数的返回值将被忽略.</p> <p><code>Promise</code> 对象是一个代理对象, 被代理的值可能是未知的. 允许为异步操作的成功或失败绑定相应处理方法.</p> <h2 id="promise-a-标准"><a href="#promise-a-标准" class="header-anchor">#</a> Promise/A+ 标准</h2> <p><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+ 标准<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h3> <ul><li><code>promise</code> 一个具拥有 <code>then</code> 方法且其行为符合规范的对象或方法.</li> <li><code>thenable</code> 一个定义了 <code>then</code> 方法的对象或函数.</li> <li><code>value</code> 指任何 JavaScript 的合法值(<code>undefined</code>,<code>thenable</code>,<code>promise</code>)</li> <li><code>exception</code> 使用 <code>throw</code> 抛出的一个值</li> <li><code>reason</code>一个表示 promise 的拒绝原因</li></ul> <h3 id="要求"><a href="#要求" class="header-anchor">#</a> 要求</h3> <h4 id="promise-状态"><a href="#promise-状态" class="header-anchor">#</a> Promise 状态</h4> <p>一个 <code>Promise</code> 的状态必须为以下状态的一种: <code>pending</code>(等待态)、<code>fulfilled</code>(执行态) 、 <code>rejected</code>(拒绝态).</p> <ul><li><code>panding</code> <ul><li><code>promise</code> 可以迁移至 <code>fulfilled</code> / <code>rejected</code> 状态</li></ul></li> <li><code>fulfilled</code> <ul><li><code>promise</code> 不能迁移至其他任何状态</li> <li><code>promise</code> 必须拥有一个<strong>不可变</strong>的终值</li></ul></li> <li><code>rejected</code> <ul><li><code>promise</code> 不能转为其他任何状态</li> <li><code>promise</code> 必须拥有一个<strong>不可变</strong>的拒因</li></ul></li></ul> <blockquote><p>不可变 =&gt; 基本值/引用地址不变的对象</p></blockquote> <h4 id="then-方法"><a href="#then-方法" class="header-anchor">#</a> then 方法</h4> <p>一个 <code>promise</code> 必须提供一个<code>then</code>方法, 以访问当前值、终值、拒因</p> <p><code>then</code> 方法接受两个参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> promise1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token comment">/** executor */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p><code>onFulfilled</code> 与 <code>onRejected</code> 皆为可选参数.</p> <ul><li>若 <code>onFulfilled</code> 不是函数, 其必须被忽略.</li> <li>若 <code>onRejected</code> 不是函数, 其必须被忽略.</li></ul></li> <li><p>若 <code>onFulfilled</code> 是一个函数.</p> <ul><li>在 <code>promise</code> 执行结束前其不可被调用.</li> <li>当 <code>promise</code> 执行结束后其必须被调用, 第一个参数为 <code>promise</code>的终值.</li> <li>其调用次数不可超过一次.</li></ul></li> <li><p>若 <code>onRejected</code> 是一个函数.</p> <ul><li>在 <code>promise</code> 被拒绝执行前其不可被调用.</li> <li>当 <code>promise</code> 被拒绝执行后其必须被调用, 第一个参数为 <code>promise</code>的拒因.</li> <li>其调用次数不可超过一次.</li></ul></li> <li><p><code>onFulfilled</code> 与 <code>onRejected</code> 调用时机.</p> <ul><li>当且仅当执行堆栈中仅包含平台代码时才可被调用.</li></ul></li> <li><p><code>onFulfilled</code> 与 <code>onRejected</code> 调用要求.</p> <ul><li>必须被作为函数调用(即无<code>this</code>值).</li></ul></li> <li><p>多次调用</p> <ul><li><code>then</code> 方法可以被同一个 <code>promise1</code> 调用多次.
<ul><li>当 <code>promise1</code> 成功执行时, 所有 <code>onFulfilled</code> 需按照其注册顺序依次回调.</li> <li>当 <code>promise1</code> 被拒绝执行时, 所有 <code>onRejected</code> 需按照其注册顺序依次回调.</li></ul></li></ul></li> <li><p>返回</p> <ul><li><p><code>then</code> 方法必须返回一个 <code>promise</code> 对象.</p> <ul><li><p>若 <code>onFulfilled</code> 或 <code>onRejected</code> 返回一个值 <code>x</code>, 则执行 <code>Promise 解决过程</code>(Promise 解决过程是一个抽象的操作, 其需输入一个 <code>promise</code> 和一个值, 表示为 <code>[[Resolve]](promise, x)</code>):</p> <ul><li><code>x</code> 与 <code>promise</code> 相等, 以<code>TypeError</code>为拒因拒绝执行 <code>promise</code>.</li> <li><code>x</code> 为 <code>Promise</code>, 使用 <code>promise</code> 接收 <code>x</code> 的状态.</li> <li><code>x</code> 为对象或函数:
<ul><li>取 <code>x.then</code> 值时抛出错误 <code>e</code>,则以 <code>e</code>为拒因拒绝 <code>promise</code>.</li> <li>若 <code>x.then</code> 为函数, 则将 <code>x</code> 作为函数作用域调用. 传递两个回调函数作为参数 (<code>resolvePromise</code>, <code>rejectPromise</code>).
<ul><li>若 <code>resolvePromise</code> 以值 <code>y</code> 为参数被调用, 则执行 <code>[[Resolve]](promise, y)</code>.</li> <li>若 <code>rejectPromise</code> 以拒因 <code>r</code> 为参数被调用, 则以 拒因 <code>r</code> 拒绝 <code>promise</code>.</li> <li>若 <code>resolvePromise</code> 和 <code>rejectPromise</code> 均被调用, 或者被同一参数调用多次, 则优先采用首次调用并忽略剩下的调用.</li> <li>若调用 <code>then</code> 方法时抛出了异常 <code>e</code> <ul><li>若 <code>resolvePromise</code>与<code>rejectPromise</code> 都已被调用, 则忽略.</li> <li>否则以拒因<code>e</code>拒绝<code>promise</code>.</li></ul></li></ul></li> <li>若 <code>x.then</code> 不是函数, 则以 <code>x</code> 为参数执行 <code>promise</code>.</li></ul></li> <li><code>x</code> 不为对象或者函数，以 <code>x</code> 为参数执行 <code>promise</code></li></ul></li> <li><p>若 <code>onFulfilled</code> 或 <code>onRejected</code> 抛出异常 <code>e</code>, <code>promise2</code> 必须拒绝执行, 并返回拒因 <code>e</code>.</p></li> <li><p>若 <code>onFulfilled</code> 不是函数且 <code>promise1</code> 成功执行, <code>promise2</code> 必须执行成功并且返回相同的值.</p></li> <li><p>若 <code>onRejected</code> 不是函数且 <code>promise1</code> 决绝执行, <code>promise2</code> 必须决绝执行并且返回相同的拒因.</p></li></ul></li></ul></li></ul> <h2 id="promise-conformant-implementations"><a href="#promise-conformant-implementations" class="header-anchor">#</a> Promise Conformant Implementations</h2> <p><a href="https://promisesaplus.com/implementations" target="_blank" rel="noopener noreferrer">Promise Conformant Implementations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.ituring.com.cn/article/66566" target="_blank" rel="noopener noreferrer">图灵社区: Promises/A+规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="promises-a-implementation-written-in-typescript"><a href="#promises-a-implementation-written-in-typescript" class="header-anchor">#</a> Promises/A+ implementation written in TypeScript</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/** https://promisesaplus.com/ */</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Value</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Reason</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Resolve</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>value<span class="token operator">:</span> Value<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Reject</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>reason<span class="token operator">:</span> Reason<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">OnFulfilled</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">OnRejected</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>resolve<span class="token operator">:</span> Resolve<span class="token punctuation">,</span> reject<span class="token operator">:</span> Reject<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> State <span class="token punctuation">{</span>
  pending <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">,</span>
  fulfilled <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span><span class="token punctuation">,</span>
  rejected <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pending<span class="token punctuation">,</span> fulfilled<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span> <span class="token operator">=</span> State<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token builtin">Promise</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> state<span class="token operator">:</span> State<span class="token punctuation">;</span>
  <span class="token keyword">private</span> value<span class="token operator">:</span> Value<span class="token punctuation">;</span>
  <span class="token keyword">private</span> reason<span class="token operator">:</span> Reason<span class="token punctuation">;</span>
  <span class="token keyword">private</span> onFulfilledCallbacks<span class="token operator">:</span> OnFulfilled<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> onRejectedCallbacks<span class="token operator">:</span> OnRejected<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>executor<span class="token operator">:</span> Executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">expecting a function but got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">classString</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** ES5 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;the promise constructor cannot be invoked directly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> pending<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">/** Promise 接收一个 executor 函数, executor 函数执行完同步或异步操作后, 调用 resolve 和 reject */</span>
      <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  resolve<span class="token operator">:</span> <span class="token function-variable function">Resolve</span> <span class="token operator">=</span> value <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/** https://promisesaplus.com/#point-14 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!==</span> pending<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> fulfilled<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>onFulfilled <span class="token operator">=&gt;</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  reject<span class="token operator">:</span> <span class="token function-variable function">Reject</span> <span class="token operator">=</span> reason <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/** https://promisesaplus.com/#point-17 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!==</span> pending<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> rejected<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>onRejected <span class="token operator">=&gt;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token operator">?</span><span class="token operator">:</span> OnFulfilled<span class="token punctuation">,</span> onRejected<span class="token operator">?</span><span class="token operator">:</span> OnRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/** https://promisesaplus.com/#point-23 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> Value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token operator">:</span> Reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> promise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">fulfilledCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> <span class="token function-variable function">rejectedCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">/** 执行态 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> fulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/** https://promisesaplus.com/#point-34 */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span>fulfilledCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/** 拒绝态 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> rejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/** https://promisesaplus.com/#point-34 */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span>rejectedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/** 等待态 */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fulfilledCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rejectedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token operator">:</span> OnRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">resolvePromise</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> promise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token punctuation">,</span> resolve<span class="token operator">:</span> Resolve<span class="token punctuation">,</span> reject<span class="token operator">:</span> Reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">promise and target refer to the same object</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 当前实现实例 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>state <span class="token operator">!==</span> pending<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 其它 Promise/A+ 实现实例 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> then <span class="token punctuation">}</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          value<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>value<span class="token operator">:</span> Value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>reason<span class="token operator">:</span> Reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">runAsync</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">classString</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> target <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#promise-是什么" title="Promise 是什么?">Promise 是什么?</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#promise-语法" title="Promise 语法">Promise 语法</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#promise-a-标准" title="Promise/A+ 标准">Promise/A+ 标准</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#术语" title="术语">术语</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#要求" title="要求">要求</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#promise-conformant-implementations" title="Promise Conformant Implementations">Promise Conformant Implementations</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#promises-a-implementation-written-in-typescript" title="Promises/A+ implementation written in TypeScript">Promises/A+ implementation written in TypeScript</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/2020/03/24/promise/.html" class="nav-link" data-v-fdbf4940>MIT Licensed | Copyright © 2020 Day</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2147977e.js" defer></script><script src="/assets/js/6.db028c5e.js" defer></script><script src="/assets/js/3.245a09f5.js" defer></script><script src="/assets/js/30.e37f3831.js" defer></script>
  </body>
</html>
